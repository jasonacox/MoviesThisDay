<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movies Released Today in History</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f3f6fa; }
        .container { margin-top: 40px; }
        h1 { font-weight: 700; margin-bottom: 30px; }
        table { background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 16px rgba(30,41,59,0.07); }
        thead { background: linear-gradient(90deg, #2563eb 0%, #60a5fa 100%); color: #fff; }
        tbody tr:hover { background: #e0e7ef; }
        .date-nav {
            background: #fff;
            border-radius: 12px;
            padding: 24px 16px;
            box-shadow: 0 4px 24px rgba(30,41,59,0.08);
            margin-bottom: 24px;
        }
        .date-nav label { font-weight: 600; color: #2563eb; }
        .date-nav input[type="date"] {
            width: 100%;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #b6c6e3;
            background: #f8fafc;
            color: #22223b;
        }
        .btn-primary {
            background: linear-gradient(90deg, #2563eb 0%, #60a5fa 100%);
            border: none;
        }
        .btn-primary:hover, .btn-primary:focus {
            background: linear-gradient(90deg, #1d4ed8 0%, #3b82f6 100%);
        }
        .btn-outline-secondary {
            border-color: #b6c6e3;
            color: #2563eb;
            background: #f8fafc;
        }
        .btn-outline-secondary:hover, .btn-outline-secondary:focus {
            background: #e0e7ef;
            color: #1d4ed8;
            border-color: #60a5fa;
        }
        @media (max-width: 991px) {
            .row.flex-lg-nowrap { flex-wrap: wrap !important; }
        }
        /* Footer styles */
        .footer {
            background: linear-gradient(90deg, #2563eb 0%, #60a5fa 100%);
            color: #fff;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 -2px 8px rgba(30,41,59,0.07);
            border-bottom: none;
            margin-bottom: 0 !important;
            padding-bottom: 0 !important;
            margin-top: 0 !important;
            padding-top: 12px !important;
            padding-bottom: 12px !important;
        }
        .footer a {
            color: #e0e7ef;
            text-decoration: underline;
        }
        /* Header styles */
        .header-bar {
            font-size: 1.15rem;
            background: linear-gradient(90deg, #2563eb 0%, #60a5fa 100%);
            color: #fff;
            padding: 14px 0 12px 0;
            margin-bottom: 0;
            z-index: 1100;
            box-shadow: 0 2px 8px rgba(30,41,59,0.07);
        }
        .header-bar span {
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .header-bar .tagline {
            font-size: 0.97rem;
            color: #e0e7ef;
        }
        .nav-link {
            color: #e0e7ef;
            transition: color 0.3s;
        }
        .nav-link:hover, .nav-link:focus {
            color: #fff;
            text-decoration: underline;
        }
        .nav-link.active {
            color: #fff;
            font-weight: 500;
        }
    </style>
    <script>
        function goToDate() {
            const dateInput = document.getElementById('dateInput').value;
            if (dateInput) {
                // Use the input value directly (YYYY-MM-DD)
                const [yyyy, mm, dd] = dateInput.split('-');
                window.location.href = `/?date=${mm}-${dd}`;
            }
        }

        function getLocalDateString() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            return now.toISOString().slice(0, 10);
        }
        function getCurrentDisplayDate() {
            // Use the value in the date input, or fallback to today if empty/invalid
            const input = document.getElementById('dateInput');
            let date = new Date(input.value);
            if (isNaN(date)) {
                date = new Date();
                date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
            }
            return date;
        }
        function pickToday() {
            document.getElementById('dateInput').value = getLocalDateString();
            goToDate();
        }
        function changeDay(delta) {
            const input = document.getElementById('dateInput');
            let date = getCurrentDisplayDate();
            // Break down the date into components
            let day = date.getDate() + delta;
            let m = date.getMonth();
            let y = date.getFullYear();
            console.log(`Changing day: ${date.toISOString()} by ${delta} days`);
            console.log(`--- Current date: ${y}-${m + 1}-${day}`);
            // Handle month/year overflow
            if (day < 1) {
                m--;
                if (m < 0) { m = 11; y--; }
                day = new Date(y, m + 1, 0).getDate(); // Get last day of previous month                
            } else {
                const lastDay = new Date(y, m, 0).getDate();
                if (day > lastDay) {
                    day = 1; // Reset to first day of next month
                    m++;
                    if (m > 11) { m = 0; y++; }
                }
            }
            // Set the new date
            console.log(`--- New date: ${y}-${m + 1}-${day}`);
            date.setFullYear(y, m, day);
            input.value = date.toISOString().slice(0, 10);
            goToDate();
        }
        function changeMonth(delta) {
            const input = document.getElementById('dateInput');
            let date = getCurrentDisplayDate();
            let m = date.getMonth() + delta;
            let y = date.getFullYear();
            let day = date.getDate();
            if (m < 0) { m = 11; y--; }
            if (m > 11) { m = 0; y++; }
            // Clamp to last day of month if needed
            const lastDay = new Date(y, m + 1, 0).getDate();
            if (day > lastDay) day = lastDay;
            date.setFullYear(y, m, day);
            input.value = date.toISOString().slice(0, 10);
            goToDate();
        }
        // Set calendar to current date on load, or to the date in the URL if present
        window.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('dateInput');
            const urlParams = new URLSearchParams(window.location.search);
            const dateParam = urlParams.get('date');
            let dateStr;
            if (dateParam) {
                // dateParam is MM-DD, convert to YYYY-MM-DD using current year
                const today = new Date();
                const yyyy = today.getFullYear();
                const [mm, dd] = dateParam.split('-');
                dateStr = `${yyyy}-${mm.padStart(2, '0')}-${dd.padStart(2, '0')}`;
            } else {
                dateStr = getLocalDateString();
            }
            // Only set if different to avoid flicker
            if (input.value !== dateStr) {
                input.value = dateStr;
            }
        });
    </script>
</head>
<body>
    <div class="header-bar fixed-top d-flex align-items-center justify-content-between px-3">
        <div class="d-flex align-items-center">
            <span style="font-size:1.25rem; font-weight:700; letter-spacing:0.5px;">MoviesThisDay</span>
            <span class="ms-2 tagline d-none d-md-inline">Discover movies released on this day in history</span>
        </div>
        <nav class="d-flex align-items-center ms-auto">
            <a class="nav-link d-inline px-2 {% if request.url.path == '/' %}active{% endif %}" href="/">Home</a>
            <a class="nav-link d-inline px-2 {% if request.url.path == '/about' %}active{% endif %}" href="/about">About</a>
            <a class="nav-link d-inline px-2 {% if request.url.path == '/search' %}active{% endif %}" href="/search">Search</a>
        </nav>
    </div>
    <div class="container" style="padding-top:20px;">
        <div class="row flex-lg-nowrap">
            <div class="col-lg-3 mb-4 d-flex flex-column align-items-center justify-content-start sticky-lg-top" style="top:80px">
                <div class="text-center mb-4" style="margin-top:50px;">
                    <h1 style="font-size:1.5rem; font-weight:700;">Movies Released on This Day in History</h1>
                    <h5 class="mb-0">
                        {% if today_str == current_date_str %}
                            Today ({{ today_str }})
                        {% else %}
                            Showing {{ today_str }}
                        {% endif %}
                    </h5>
                </div>
                <div class="date-nav mt-4" style="width:100%; max-width:240px;">
                    <label for="dateInput" class="form-label">Jump to Date</label>
                    <input type="date" id="dateInput" class="form-control mb-2" max="{{ max_date }}">
                    <div class="d-flex gap-2 mb-2">
                        <button class="btn btn-outline-secondary flex-fill" type="button" onclick="changeDay(-1)">&lt; Day</button>
                        <button class="btn btn-outline-secondary flex-fill" type="button" onclick="changeDay(1)">Day &gt;</button>
                    </div>
                    <div class="d-flex gap-2 mb-2">
                        <button class="btn btn-outline-secondary flex-fill" type="button" onclick="changeMonth(-1)">&lt; Month</button>
                        <button class="btn btn-outline-secondary flex-fill" type="button" onclick="changeMonth(1)">Month &gt;</button>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary flex-fill" onclick="goToDate()">Go</button>
                        <button class="btn btn-outline-secondary flex-fill" type="button" onclick="pickToday()">Now</button>
                    </div>
                </div>
            </div>
            <div class="col-lg-9 d-flex flex-column" style="height: 90vh; padding-bottom:40px;">
                <form class="mb-3 d-flex justify-content-end align-items-center" method="get">
                    {% if request.query_params.get('date') %}
                        <input type="hidden" name="date" value="{{ request.query_params.get('date') }}">
                    {% endif %}
                    <label for="sort" class="me-2 mb-0">Sort by:</label>
                    <select name="sort" id="sort" class="form-select w-auto me-2" onchange="this.form.submit()">
                        <option value="popularity" {% if sort_by == 'popularity' %}selected{% endif %}>Popularity</option>
                        <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Name</option>
                        <option value="year" {% if sort_by == 'year' %}selected{% endif %}>Year</option>
                    </select>
                </form>
                <div class="flex-grow-1 overflow-auto" style="min-height:0;">
                    <table class="table table-striped table-hover shadow mb-0" style="table-layout:fixed;">
                        <thead>
                            <tr>
                                <th style="width:auto; min-width:120px;">Title</th>
                                <th style="width:70px;">Year</th>
                                <th style="width:80px;">Runtime</th>
                                <th style="width:120px;">Popularity</th>
                                <th style="width:70px;">IMDB</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for movie in movies %}
                            <tr>
                                <td style="word-break:break-word; white-space:normal;">{{ movie.title }}</td>
                                <td>{{ movie.release_year }}</td>
                                <td>{% if movie.runtime %}{{ movie.runtime }} min{% else %}-{% endif %}</td>
                                <td>
                                    {% set pop = movie.popularity|float(0) %}
                                    {% set pop_pct = (pop / popularity_max * 50) if popularity_max and popularity_max > 0 else (pop if pop < 100 else 100) %}
                                    {% if pop_pct > 100 %}{% set pop_pct = 100 %}{% endif %}
                                    <div style="background:#e0e7ef; border-radius:6px; height:18px; width:100px; position:relative;">
                                        <div style="background:linear-gradient(90deg,#2563eb,#60a5fa); height:100%; border-radius:6px; width:{{ pop_pct|round(0,'floor') }}%; transition:width 0.3s;"></div>
                                        <span style="position:absolute; left:8px; top:0; font-size:0.95em; color:#222; line-height:18px; font-weight:500;">{{ pop|round(0,'floor') }}</span>
                                    </div>
                                </td>
                                <td>{% if movie.imdb_id %}<a href="https://www.imdb.com/title/{{ movie.imdb_id }}" target="_blank">IMDB</a>{% else %}-{% endif %}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                <!-- Footer -->
            </div>
        </div>
    </div>
    <div class="footer text-center" style="font-size:0.95rem;">
        Powered by <a href="https://github.com/jasonacox/MoviesThisDay" target="_blank">MoviesThisDay</a>
    </div>
</body>
</html>
